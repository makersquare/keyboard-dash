<html>
<head>
  <title>Keyboard Dash!</title>
  <link rel="stylesheet" href="bower_components/codemirror/lib/codemirror.css" />
  <link rel="stylesheet" href="bower_components/codemirror/theme/blackboard.css" />
  <style type="text/css">
    .container {
      max-width: 960px;
      margin: 0 auto;
    }
    .dummy-form { clear: both; }
    ul.shortcut-list li {
      float: left;
      list-style: none;
      width: 112px;
      margin-bottom: 10px;
    }
    #stats { clear: both; }
  </style>
</head>
<body>

<div class="container">

  <h1>Keboard <em>Dash</em></h1>

  <p>Delete all `x` characters. You are restricted to the listed keyboard shortcuts.</p>

  <ul class="shortcut-list"></ul>

  <div id="stats">
    <label class="progress">0</label> / <label class="total">0</label>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <label><span class="stroke-count">0</span> strokes</label><br />
  </div>

  <form class="dummy-form">
    <textarea id="editor">
 x  _xx__xx__ xx   x   x      x               _       _
  xx/ x_xx__x_xx|  x  x  x x   x      xx       x   | |   xxx  | xx|x
 xx| |x  xxx   x__xxx  xxx_x x__xx   _xxx_ _ _x xx_xx_ __xx _x| |_x ___|x |
 | |    / _ \| '_ \xxx / xxxx_xx` x| '__/xx _` | x__/ __x|xx |x
 | xx|x_xxx_xx_x| (_x)x xx| |x xx| |xxxx (_|x |x | xx| xxx(_|x | x|_\__ \_|
  xx\x_x_x_xxx_\__x_xxxx/|_| xx|_x|xxx\_xx_,xx |_x|  \__xxxx,_|\_x_|xxx___xxxxx(_xx)
 x  x x   xx   x x     xx x  x x __/ |xxx
 x x xx   x xx  xx  xx  xx  xxxxx  x xx xxx |___xx/xxx
  </textarea>
  </form>

</div>

<script src="bower_components/codemirror/lib/codemirror.js"></script>
<script src="bower_components/jquery/dist/jquery.js"></script>
<script type="text/javascript">
(function () {

  var textarea = document.getElementById('editor');
  var keyMap = CodeMirror.keyMap['training'] = {
    "Ctrl-F": "goCharRight", "Ctrl-B": "goCharLeft", "Ctrl-P": "goLineUp", "Ctrl-N": "goLineDown",
    "Alt-F": "goWordRight", "Alt-B": "goWordLeft", "Ctrl-A": "goLineStart", "Ctrl-E": "goLineEnd",
    "Ctrl-V": "goPageDown", "Alt-V": "goPageUp", "Ctrl-D": "delCharAfter", "Ctrl-H": "delCharBefore",
    "Alt-D": "delWordAfter", "Alt-Backspace": "delWordBefore", "Ctrl-K": "killLine", "Ctrl-T": "transposeChars"
  }

  for (var keystroke in keyMap) {
    var name = keyMap[keystroke]
    $('.shortcut-list').append("<li><b>" + keystroke + ":</b><br />" + name + "</li>");
  }

  $('#stats .total').text(textarea.value.split('x').length - 1);

  window.Dash = {
    lastKeypressProductivity: 0,
    progress: 0,
    history: [],
    trainer: CodeMirror.fromTextArea(textarea, {
      lineNumbers: true,
      mode: "text/html",
      theme: "blackboard",
      keyMap: "training"
    })
  };

  Dash.trainer.on('keyHandled', function (editor, name, e) {
    // Add keystroke to history
    Dash.history.push({ keystroke: name, productivity: Dash.lastKeypressProductivity });
    Dash.progress += Dash.lastKeypressProductivity;
    Dash.lastKeypressProductivity = 0; // Just in case
    $('#stats .stroke-count').text(Dash.history.length);
    $('#stats .progress').text(Dash.progress);
  });

  Dash.trainer.on('beforeChange', function (editor, change) {
    if (change.text[0]) {
      console.log("You can't add your own characters!");
      change.cancel();
      return;
    }
    var deletingChars = editor.doc.getRange(change.from, change.to);
    if (deletingChars.match(/[^x]/)) {
      console.log("You can only delete x characters!");
      change.cancel();
      return;
    }
    Dash.lastKeypressProductivity = deletingChars.split('x').length - 1;
  });
})();
</script>

</body>
</html>
