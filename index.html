<html>
<head>
  <title>Keyboard Dash!</title>
  <link rel="stylesheet" href="bower_components/codemirror/lib/codemirror.css" />
  <link rel="stylesheet" href="bower_components/codemirror/theme/blackboard.css" />
  <style type="text/css">
    .container {
      max-width: 960px;
      margin: 0 auto;
    }
    .dummy-form { clear: both; }
    ul.shortcut-list li {
      float: left;
      list-style: none;
      width: 112px;
      margin-bottom: 10px;
    }
    #stats { clear: both; }
  </style>
</head>
<body>

<div class="container">

  <h1>Keboard <em>Dash</em></h1>

  <p>Delete all `x` characters. You are restricted to the listed keyboard shortcuts.</p>

  <ul class="shortcut-list"></ul>

  <div id="stats">
    <label class="progress">0</label> / <label class="total">0</label>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <label><span class="stroke-count">0</span> strokes</label>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <label class="timer">Click anywhere and delete an `x` to start!</label>
  </div>

  <form class="dummy-form">
    <textarea id="editor">
   _____ xx   x   x      x               _       _
  xx/ x___x_|  x  x  x x   x      xx       x   | |     | |x
 xx| |   xxx   __  _ __x   __ _ _x __ __ _x| |_x ___|x |
 | |    / _ \| '_ \xxx / _` x| '__/xx _` | x__/ __|xx |x
 | x|x___| (_x)x xx| |x xx| |xxx (_|x |x | xx| (_|x | x|_\__ \_|
  x\x_____\___/|_| xx|_x|\__,xx |_x|  \__,_|\_x_|___(_xx)
           x     xx x  x x __/ |xxx
 x x    x xx  xx  xx  xx  xx  x xx xxx |___xx/xxx
  </textarea>
  </form>

</div>

<script src="bower_components/codemirror/lib/codemirror.js"></script>
<script src="bower_components/jquery/dist/jquery.js"></script>
<script type="text/javascript">
(function () {

  var textarea = document.getElementById('editor');
  var keyMap = CodeMirror.keyMap['training'] = {
    "Ctrl-F": "goCharRight", "Ctrl-B": "goCharLeft", "Ctrl-P": "goLineUp", "Ctrl-N": "goLineDown",
    "Alt-F": "goWordRight", "Alt-B": "goWordLeft", "Ctrl-A": "goLineStart", "Ctrl-E": "goLineEnd",
    "Ctrl-V": "goPageDown", "Alt-V": "goPageUp", "Ctrl-D": "delCharAfter", "Ctrl-H": "delCharBefore",
    "Alt-D": "delWordAfter", "Alt-Backspace": "delWordBefore", "Ctrl-K": "killLine", "Ctrl-T": "transposeChars"
  }

  for (var keystroke in keyMap) {
    var name = keyMap[keystroke]
    $('.shortcut-list').append("<li><b>" + keystroke + ":</b><br />" + name + "</li>");
  }

  $('#stats .total').text(textarea.value.split('x').length - 1);

  var Dash = function () {
    var counter = 0;
    var lastKeypressScore = 0;

    this.history = [];
    this.score = 0;
    this.startTime = (new Date()).getTime();
    this.stopTime = null;

    this.tick = function () {
      counter += 1;
      this.history.push({ tick: counter });
      return counter;
    };
    this.recordPoints = function (amount) {
      lastKeypressScore = amount;
    };
    this.recordKeystroke = function (keystroke) {
      this.history.push({ keystroke: name, points: lastKeypressScore });
      this.score += lastKeypressScore;
      lastKeypressScore = 0;
    }
    this.end = function () {
      this.stopTime = (new Date()).getTime();
    };
  };

  window.KeyboardDash = {
    trainer: CodeMirror.fromTextArea(textarea, {
      lineNumbers: true,
      mode: "text/html",
      theme: "blackboard",
      keyMap: "training"
    }),
    current: null,
    start: function () {
      this.current = new Dash();
      $('.timer').text("00:00 - Go!");

      var dash = this.current;
      KeyboardDash.timer = setInterval(function () {
        var totalSeconds = dash.tick();
        var minutes = parseInt(totalSeconds / 60)
        var seconds = (totalSeconds % 60);
        var formatted = (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
        $('.timer').text(formatted);
      }, 1000);
    },
    finish: function () {
      clearTimeout(KeyboardDash.timer);
    }
  };

  KeyboardDash.trainer.on('keyHandled', function (editor, name, e) {
    if (!KeyboardDash.current) return;
    // Add keystroke to history
    KeyboardDash.current.recordKeystroke(name)
    $('#stats .stroke-count').text(KeyboardDash.current.history.length);
    $('#stats .progress').text(KeyboardDash.current.score);
  });

  KeyboardDash.trainer.on('beforeChange', function (editor, change) {
    if (change.text[0]) {
      console.log("You can't add your own characters!");
      change.cancel();
      return;
    }
    var deletingChars = editor.doc.getRange(change.from, change.to);
    if (deletingChars.match(/[^x]/)) {
      console.log("You can only delete x characters!");
      change.cancel();
      return;
    }

    if (!KeyboardDash.current) {
      KeyboardDash.start();
    }
    var points = deletingChars.split('x').length - 1;
    KeyboardDash.current.recordPoints(points);
  });
})();
</script>

</body>
</html>
